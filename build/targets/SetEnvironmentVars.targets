<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="15.0">

  <!-- Target to set environment variables before PreBuildEvent -->
  <Target Name="SetEnvironmentVars" BeforeTargets="PreBuildEvent">
    <Message Importance="normal" Text="Setting RepoRootDirectory and BuildConfiguration environment variables for use during build." />
    <SetEnvironmentVar EnvironmentVarName="BuildConfiguration" EnvironmentVarValue="$(Configuration)" />
    <SetEnvironmentVar EnvironmentVarName="RepoRootDirectory" EnvironmentVarValue="$(RepoRoot)" />
  </Target>

  <!-- Custom task to add environment variables to the current process execution -->
  <UsingTask TaskName="SetEnvironmentVar"
             TaskFactory="RoslynCodeTaskFactory"
             AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll">
    <ParameterGroup>
      <EnvironmentVarName ParameterType="System.String" Required="true" />
      <EnvironmentVarValue ParameterType="System.String" Required="true" />
    </ParameterGroup>
    <Task>
      <Using Namespace="System" />
      <Using Namespace="System.IO" />
      <Code Type="Fragment" Language="cs">
        <![CDATA[
          if (!string.IsNullOrWhiteSpace(EnvironmentVarName))
          {
              Log.LogMessage(MessageImportance.High, $"[SetEnv] {EnvironmentVarName} = {EnvironmentVarValue}");
              Environment.SetEnvironmentVariable(EnvironmentVarName, EnvironmentVarValue, EnvironmentVariableTarget.Process);
          }
          else
          {
              Log.LogWarning("[SetEnv] Skipped setting environment variable due to missing name.");
          }
        ]]>
      </Code>
    </Task>
  </UsingTask>

</Project>
